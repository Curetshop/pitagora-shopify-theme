{%- liquid
  assign show_vendor = section.settings.show_vendor | default: false
  assign show_rating = section.settings.show_rating | default: true
  assign show_quick_view = section.settings.show_quick_view | default: true
  assign is_fallback = is_fallback | default: false
  
  assign product_form_id = 'product-form-upsell-' | append: product.id | append: '-' | append: section.id
  assign product_url = product.url
  assign product_title = block.settings.custom_title | default: product.title
-%}

<div class="cart-upsells__card" 
     data-product-id="{{ product.id }}"
     {% if block %}{{ block.shopify_attributes }}{% endif %}>
  <div class="cart-upsells__card-content">
    
    {%- comment -%} Product Images {%- endcomment -%}
    <div class="cart-upsells__image-wrapper">
      <a href="{{ product_url }}" class="cart-upsells__image-link">
        
        {%- comment -%} Primary Image {%- endcomment -%}
        {%- if product.featured_media -%}
          {{ product.featured_media | image_url: width: 400 | image_tag: 
            class: 'cart-upsells__image',
            loading: 'lazy',
            sizes: '(min-width: 1200px) 300px, (min-width: 768px) 250px, 200px',
            widths: '200, 250, 300, 400, 500, 600'
          }}
        {%- else -%}
          {{ 'product-1' | placeholder_svg_tag: 'cart-upsells__image cart-upsells__image--placeholder' }}
        {%- endif -%}
        
        {%- comment -%} Hover Image {%- endcomment -%}
        {%- if product.media[1] != null and show_quick_view -%}
          {{ product.media[1] | image_url: width: 400 | image_tag: 
            class: 'cart-upsells__image-hover',
            loading: 'lazy',
            sizes: '(min-width: 1200px) 300px, (min-width: 768px) 250px, 200px',
            widths: '200, 250, 300, 400, 500, 600'
          }}
        {%- endif -%}
        
        {%- comment -%} Sale Badge {%- endcomment -%}
        {%- if product.compare_at_price > product.price -%}
          <div class="cart-upsells__badge cart-upsells__badge--sale">
            <span class="cart-upsells__badge-text">{{ 'products.product.sale' | t }}</span>
            {%- assign discount = product.compare_at_price | minus: product.price | times: 100 | divided_by: product.compare_at_price -%}
            <span class="cart-upsells__badge-discount">-{{ discount }}%</span>
          </div>
        {%- endif -%}
        
        {%- comment -%} Quick View Button {%- endcomment -%}
        {%- if show_quick_view -%}
          <button class="cart-upsells__quick-view"
                  data-quick-view
                  data-product-handle="{{ product.handle }}"
                  aria-label="{{ 'products.product.quick_view' | t }}: {{ product_title }}">
            <svg class="icon icon--eye" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z"/>
            </svg>
          </button>
        {%- endif -%}
      </a>
    </div>

    {%- comment -%} Product Info {%- endcomment -%}
    <div class="cart-upsells__info">
      
      {%- comment -%} Product Title {%- endcomment -%}
      <h4 class="cart-upsells__product-title">
        <a href="{{ product_url }}" class="cart-upsells__title-link">{{ product_title }}</a>
      </h4>
      
      {%- comment -%} Vendor {%- endcomment -%}
      {%- if show_vendor and product.vendor != blank -%}
        <div class="cart-upsells__vendor">{{ product.vendor }}</div>
      {%- endif -%}
      
      {%- comment -%} Rating (Mock for now) {%- endcomment -%}
      {%- if show_rating -%}
        {%- assign rating_value = 4 | plus: 1 | times: 1.0 | divided_by: 1.2 | round: 1 -%}
        {%- assign rating_stars = rating_value | floor -%}
        {%- assign rating_count = 15 | plus: product.id | modulo: 50 | plus: 5 -%}
        
        <div class="cart-upsells__rating">
          <div class="cart-upsells__stars" aria-label="{{ rating_value }} {{ 'accessibility.star_reviews_info' | t }}">
            {%- for i in (1..5) -%}
              <svg class="cart-upsells__star {% if i <= rating_stars %}cart-upsells__star--filled{% endif %}" 
                   viewBox="0 0 24 24" aria-hidden="true">
                <path fill="currentColor" d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z"/>
              </svg>
            {%- endfor -%}
          </div>
          <span class="cart-upsells__rating-count">({{ rating_count }})</span>
        </div>
      {%- endif -%}

      {%- comment -%} Price {%- endcomment -%}
      <div class="cart-upsells__price-wrapper">
        <div class="cart-upsells__price">
          {%- render 'price', product: product, use_variant: true -%}
        </div>
      </div>
      
      {%- comment -%} Variant Options (for products with variants) {%- endcomment -%}
      {%- if product.has_only_default_variant == false -%}
        <div class="cart-upsells__variants">
          {%- for option in product.options_with_values -%}
            {%- if option.name == 'Color' or option.name == 'Colour' -%}
              <div class="cart-upsells__variant-swatches" data-option-index="{{ forloop.index0 }}">
                <span class="cart-upsells__variant-label">{{ option.name }}:</span>
                <div class="cart-upsells__swatch-group">
                  {%- for value in option.values limit: 4 -%}
                    {%- assign variant = product.variants | where: option.name, value | first -%}
                    <button class="cart-upsells__swatch {% if forloop.first %}is-active{% endif %}"
                            data-variant-id="{{ variant.id }}"
                            data-variant-available="{{ variant.available }}"
                            title="{{ value }}"
                            style="background-color: {{ value | handleize }};">
                      <span class="visually-hidden">{{ value }}</span>
                    </button>
                  {%- endfor -%}
                  {%- if option.values.size > 4 -%}
                    <span class="cart-upsells__more-variants">+{{ option.values.size | minus: 4 }}</span>
                  {%- endif -%}
                </div>
              </div>
            {%- endif -%}
          {%- endfor -%}
        </div>
      {%- endif -%}
      
      {%- comment -%} Add to Cart Form {%- endcomment -%}
      <form class="cart-upsells__form" 
            id="{{ product_form_id }}"
            data-product-form
            data-product-handle="{{ product.handle }}">
        
        {%- unless product.has_only_default_variant -%}
          <input type="hidden" 
                 name="id" 
                 value="{{ product.selected_or_first_available_variant.id }}"
                 data-variant-input>
        {%- else -%}
          <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
        {%- endunless -%}
        
        <input type="hidden" name="quantity" value="1">
        
        <button type="submit" 
                class="cart-upsells__add-button button button--primary"
                data-add-to-cart
                {% unless product.selected_or_first_available_variant.available %}disabled{% endunless %}>
          
          <span class="cart-upsells__add-text">
            {%- if product.selected_or_first_available_variant.available -%}
              {{ 'products.product.add_to_cart' | t }}
            {%- else -%}
              {{ 'products.product.sold_out' | t }}
            {%- endif -%}
          </span>
          
          <div class="cart-upsells__add-loading" style="display: none;">
            <div class="cart-upsells__add-spinner"></div>
          </div>
        </button>
      </form>
    </div>
  </div>
</div>