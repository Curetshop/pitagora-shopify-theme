{%- comment -%}
  CSS Variables System - Based on Focal v4 architecture
  Generates dynamic CSS custom properties from theme settings
{%- endcomment -%}

{%- liquid
  assign heading_font_italic = settings.heading_font | font_modify: 'style', 'italic'
  assign body_font_italic = settings.body_font | font_modify: 'style', 'italic' 
  assign body_font_bold = settings.body_font | font_modify: 'weight', '600'
  
  unless body_font_bold
    assign body_font_bold = settings.body_font | font_modify: 'weight', '500'
  endunless
  
  unless body_font_bold
    assign body_font_bold = settings.body_font | font_modify: 'weight', 'bolder'
  endunless
  
  assign body_font_bold_italic = body_font_bold | font_modify: 'style', 'italic'
-%}

{%- comment -%} Font Preloading - Performance optimization {%- endcomment -%}
{%- unless settings.heading_font.system? -%}
  <link rel="preload" href="{{ settings.heading_font | font_url }}" as="font" type="font/woff2" crossorigin>
{%- endunless -%}

{%- unless settings.body_font.system? -%}
  <link rel="preload" href="{{ settings.body_font | font_url }}" as="font" type="font/woff2" crossorigin>
{%- endunless -%}

<style>
  {%- comment -%} Font Face Declarations {%- endcomment -%}
  {{ settings.heading_font | font_face: font_display: 'swap' }}
  
  {%- if heading_font_italic -%}
    {{ heading_font_italic | font_face: font_display: 'swap' }}
  {%- endif -%}

  {{ settings.body_font | font_face: font_display: 'swap' }}
  
  {%- if body_font_italic -%}
    {{ body_font_italic | font_face: font_display: 'swap' }}
  {%- endif -%}
  
  {%- if body_font_bold -%}
    {{ body_font_bold | font_face: font_display: 'swap' }}
  {%- endif -%}
  
  {%- if body_font_bold_italic -%}
    {{ body_font_bold_italic | font_face: font_display: 'swap' }}
  {%- endif -%}

  {%- comment -%} CSS Custom Properties - Dynamic theme variables {%- endcomment -%}
  :root {
    /* Colors - RGB format with comprehensive fallbacks */
    --color-primary: {{ settings.colors_accent_1 | default: '#121212' | color_to_rgb | remove: 'rgb(' | remove: ')' | default: '18, 18, 18' }};
    --color-primary-fallback: 18, 18, 18; /* Dark fallback */
    
    --color-secondary: {{ settings.colors_accent_2 | default: '#334fb4' | color_to_rgb | remove: 'rgb(' | remove: ')' | default: '51, 79, 180' }};
    --color-secondary-fallback: 51, 79, 180; /* Blue fallback */
    
    --color-accent: {{ settings.colors_accent_2 | default: '#334fb4' | color_to_rgb | remove: 'rgb(' | remove: ')' | default: '51, 79, 180' }};
    --color-accent-fallback: 51, 79, 180; /* Blue fallback */
    
    --color-foreground: {{ settings.colors_text | default: '#121212' | color_to_rgb | remove: 'rgb(' | remove: ')' | default: '18, 18, 18' }};
    --color-foreground-fallback: 18, 18, 18; /* Dark gray fallback */
    
    --color-background: {{ settings.colors_background_1 | default: '#ffffff' | color_to_rgb | remove: 'rgb(' | remove: ')' | default: '255, 255, 255' }};
    --color-background-fallback: 255, 255, 255; /* White fallback */
    
    /* Hex format for backward compatibility */
    --color-primary-hex: {{ settings.colors_accent_1 | default: '#121212' }};
    --color-secondary-hex: {{ settings.colors_accent_2 | default: '#334fb4' }};
    --color-accent-hex: {{ settings.colors_accent_2 | default: '#334fb4' }};
    --color-text-hex: {{ settings.colors_text | default: '#121212' }};
    --color-background-hex: {{ settings.colors_background_1 | default: '#ffffff' }};
    
    /* Color variations */
    --color-primary-light: rgba(var(--color-primary), 0.1);
    --color-primary-dark: rgba(var(--color-primary), 0.8);
    --color-text-light: rgba(var(--color-foreground), 0.7);
    --color-text-lighter: rgba(var(--color-foreground), 0.5);
    
    /* Shopify Online Store 2.0 Color Scheme Variables */
    --color-base-text: {{ settings.colors_text.red }}, {{ settings.colors_text.green }}, {{ settings.colors_text.blue }};
    --color-shadow: {{ settings.colors_text.red }}, {{ settings.colors_text.green }}, {{ settings.colors_text.blue }};
    --color-base-background-1: {{ settings.colors_background_1.red }}, {{ settings.colors_background_1.green }}, {{ settings.colors_background_1.blue }};
    --color-base-background-2: {{ settings.colors_background_2.red }}, {{ settings.colors_background_2.green }}, {{ settings.colors_background_2.blue }};
    --color-base-solid-button-labels: {{ settings.colors_solid_button_labels.red }}, {{ settings.colors_solid_button_labels.green }}, {{ settings.colors_solid_button_labels.blue }};
    --color-base-accent-1: {{ settings.colors_accent_1.red }}, {{ settings.colors_accent_1.green }}, {{ settings.colors_accent_1.blue }};
    --color-base-accent-2: {{ settings.colors_accent_2.red }}, {{ settings.colors_accent_2.green }}, {{ settings.colors_accent_2.blue }};
    --color-base-outline-button-labels: {{ settings.colors_outline_button_labels.red }}, {{ settings.colors_outline_button_labels.green }}, {{ settings.colors_outline_button_labels.blue }};
    
    /* Gradient variables */
    --gradient-base-background-1: {% if settings.gradient_background_1 != blank %}{{ settings.gradient_background_1 }}{% else %}{{ settings.colors_background_1 }}{% endif %};
    --gradient-base-background-2: {% if settings.gradient_background_2 != blank %}{{ settings.gradient_background_2 }}{% else %}{{ settings.colors_background_2 }}{% endif %};
    --gradient-base-accent-1: {% if settings.gradient_accent_1 != blank %}{{ settings.gradient_accent_1 }}{% else %}{{ settings.colors_accent_1 }}{% endif %};
    --gradient-base-accent-2: {% if settings.gradient_accent_2 != blank %}{{ settings.gradient_accent_2 }}{% else %}{{ settings.colors_accent_2 }}{% endif %};
    
    /* Typography with robust fallbacks */
    --font-heading: {{ settings.heading_font.family | default: 'Inter' | append: ', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif' }};
    --font-heading-fallback: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    
    --font-body: {{ settings.body_font.family | default: 'Inter' | append: ', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif' }};
    --font-body-fallback: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    
    --font-heading-scale: {{ settings.heading_font_scale | default: 120 | divided_by: 100.0 | default: 1.2 }};
    --font-heading-scale-fallback: 1.2;
    
    --font-body-scale: {{ settings.body_font_scale | default: 100 | divided_by: 100.0 | default: 1.0 }};
    --font-body-scale-fallback: 1.0;
    
    --font-heading-weight: {{ settings.heading_font.weight | default: '700' }};
    --font-heading-weight-fallback: 700;
    
    --font-body-weight: {{ settings.body_font.weight | default: '400' }};
    --font-body-weight-fallback: 400;
    
    /* Font sizes - Fluid typography */
    --font-size-xs: calc(0.75rem * var(--font-body-scale));
    --font-size-sm: calc(0.875rem * var(--font-body-scale));
    --font-size-base: calc(1rem * var(--font-body-scale));
    --font-size-lg: calc(1.125rem * var(--font-body-scale));
    --font-size-xl: calc(1.25rem * var(--font-body-scale));
    --font-size-2xl: calc(1.5rem * var(--font-heading-scale));
    --font-size-3xl: calc(1.875rem * var(--font-heading-scale));
    --font-size-4xl: calc(2.25rem * var(--font-heading-scale));
    --font-size-5xl: calc(3rem * var(--font-heading-scale));
    
    /* Layout & Spacing with fallbacks */
    --container-width: {{ settings.container_width | default: '1400' | append: 'px' | default: '1400px' }};
    --container-width-fallback: 1400px;
    
    --border-radius-sm: {{ settings.button_border_radius | default: 4 | divided_by: 2 | default: 2 }}px;
    --border-radius-sm-fallback: 2px;
    
    --border-radius: {{ settings.button_border_radius | default: 4 | default: 4 }}px;
    --border-radius-fallback: 4px;
    
    --border-radius-lg: {{ settings.button_border_radius | default: 4 | times: 1.5 | default: 6 }}px;
    --border-radius-lg-fallback: 6px;
    
    /* Spacing scale */
    --spacing-xs: 0.5rem;
    --spacing-sm: 0.75rem;
    --spacing-md: 1rem;
    --spacing-lg: 1.5rem;
    --spacing-xl: 2rem;
    --spacing-2xl: 3rem;
    --spacing-3xl: 4rem;
    
    /* Standardized Breakpoint System */
    --breakpoint-xs: 480px;    /* Extra small devices */
    --breakpoint-sm: 640px;    /* Small devices */
    --breakpoint-md: 768px;    /* Medium devices (tablets) */
    --breakpoint-lg: 1024px;   /* Large devices (laptops) */
    --breakpoint-xl: 1200px;   /* Extra large devices (desktops) */
    --breakpoint-2xl: 1400px;  /* 2X Extra large devices */
    
    /* Grid & Layout */
    --grid-gutter: var(--spacing-md);
    --grid-columns: {{ settings.collection_layout | default: 3 }};
    
    /* Shadows */
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    
    /* Transitions */
    --transition-fast: 150ms ease-in-out;
    --transition-base: 250ms ease-in-out;
    --transition-slow: 350ms ease-in-out;
    
    /* Z-index scale */
    --z-index-dropdown: 100;
    --z-index-sticky: 200;
    --z-index-overlay: 500;
    --z-index-modal: 1000;
    --z-index-toast: 1500;
    
    /* Logo */
    --logo-width: {{ settings.logo_width | default: 160 }}px;
    --logo-width-mobile: calc(var(--logo-width) * 0.8);
    
    /* Shopify Online Store 2.0 Additional Variables */
    --page-width: {{ settings.page_width | default: 1200 | divided_by: 10 }}rem;
    --page-width-margin: {% if settings.page_width == '1600' %}2{% else %}0{% endif %}rem;
    
    --spacing-sections: {{ settings.spacing_sections | default: 0 }}px;
    --grid-desktop-vertical-spacing: {{ settings.spacing_grid_vertical | default: 8 }}px;
    --grid-desktop-horizontal-spacing: {{ settings.spacing_grid_horizontal | default: 8 }}px;
    --grid-mobile-vertical-spacing: {{ settings.spacing_grid_vertical | default: 8 | divided_by: 2 }}px;
    --grid-mobile-horizontal-spacing: {{ settings.spacing_grid_horizontal | default: 8 | divided_by: 2 }}px;
    
    /* Button variables */
    --buttons-radius: {{ settings.buttons_radius | default: 0 }}px;
    --buttons-radius-outset: {% if settings.buttons_radius > 0 %}{{ settings.buttons_radius | plus: settings.buttons_border_thickness }}{% else %}0{% endif %}px;
    --buttons-border-width: {% if settings.buttons_border_opacity > 0 %}{{ settings.buttons_border_thickness }}{% else %}0{% endif %}px;
    --buttons-border-opacity: {{ settings.buttons_border_opacity | default: 100 | divided_by: 100.0 }};
    --buttons-shadow-opacity: {{ settings.buttons_shadow_opacity | default: 0 | divided_by: 100.0 }};
    --buttons-shadow-horizontal-offset: {{ settings.buttons_shadow_horizontal_offset | default: 0 }}px;
    --buttons-shadow-vertical-offset: {{ settings.buttons_shadow_vertical_offset | default: 4 }}px;
    --buttons-shadow-blur-radius: {{ settings.buttons_shadow_blur | default: 5 }}px;
    --buttons-border-offset: {% if settings.buttons_radius > 0 or settings.buttons_shadow_opacity > 0 %}0.3{% else %}0{% endif %}px;
    
    /* Input variables */
    --inputs-radius: {{ settings.inputs_radius | default: 0 }}px;
    --inputs-border-width: {{ settings.inputs_border_thickness | default: 1 }}px;
    --inputs-border-opacity: {{ settings.inputs_border_opacity | default: 55 | divided_by: 100.0 }};
    --inputs-shadow-opacity: {{ settings.inputs_shadow_opacity | default: 0 | divided_by: 100.0 }};
    --inputs-shadow-horizontal-offset: {{ settings.inputs_shadow_horizontal_offset | default: 0 }}px;
    --inputs-margin-offset: {% if settings.inputs_shadow_vertical_offset != 0 and settings.inputs_shadow_opacity > 0 %}{{ settings.inputs_shadow_vertical_offset | abs }}{% else %}0{% endif %}px;
    --inputs-shadow-vertical-offset: {{ settings.inputs_shadow_vertical_offset | default: 4 }}px;
    --inputs-shadow-blur-radius: {{ settings.inputs_shadow_blur | default: 5 }}px;
    --inputs-radius-outset: {% if settings.inputs_radius > 0 %}{{ settings.inputs_radius | plus: settings.inputs_border_thickness }}{% else %}0{% endif %}px;
    
    /* Card variables */
    --card-image-padding: {{ settings.card_image_padding | default: 0 | divided_by: 10.0 }}rem;
    --card-corner-radius: {{ settings.card_corner_radius | default: 0 | divided_by: 10.0 }}rem;
    --card-text-alignment: {{ settings.card_text_alignment | default: 'left' }};
    --card-border-width: {{ settings.card_border_thickness | default: 0 | divided_by: 10.0 }}rem;
    --card-border-opacity: {{ settings.card_border_opacity | default: 10 | divided_by: 100.0 }};
    --card-shadow-opacity: {{ settings.card_shadow_opacity | default: 0 | divided_by: 100.0 }};
    --card-shadow-horizontal-offset: {{ settings.card_shadow_horizontal_offset | default: 0 | divided_by: 10.0 }}rem;
    --card-shadow-vertical-offset: {{ settings.card_shadow_vertical_offset | default: 4 | divided_by: 10.0 }}rem;
    --card-shadow-blur-radius: {{ settings.card_shadow_blur | default: 5 | divided_by: 10.0 }}rem;
    
    /* Badge variables */
    --badge-corner-radius: {{ settings.badge_corner_radius | default: 40 | divided_by: 10.0 }}rem;
    
    /* Media variables */
    --media-padding: {{ settings.media_padding | default: 0 }}px;
    --media-border-opacity: {{ settings.media_border_opacity | default: 5 | divided_by: 100.0 }};
    --media-border-width: {{ settings.media_border_thickness | default: 1 }}px;
    --media-radius: {{ settings.media_radius | default: 0 }}px;
    --media-shadow-opacity: {{ settings.media_shadow_opacity | default: 0 | divided_by: 100.0 }};
    --media-shadow-horizontal-offset: {{ settings.media_shadow_horizontal_offset | default: 0 }}px;
    --media-shadow-vertical-offset: {{ settings.media_shadow_vertical_offset | default: 4 }}px;
    --media-shadow-blur-radius: {{ settings.media_shadow_blur | default: 5 }}px;
    
    /* Popup variables */
    --popup-border-width: {{ settings.popup_border_thickness | default: 1 }}px;
    --popup-border-opacity: {{ settings.popup_border_opacity | default: 10 | divided_by: 100.0 }};
    --popup-corner-radius: {{ settings.popup_corner_radius | default: 0 }}px;
    --popup-shadow-opacity: {{ settings.popup_shadow_opacity | default: 0 | divided_by: 100.0 }};
    --popup-shadow-horizontal-offset: {{ settings.popup_shadow_horizontal_offset | default: 0 }}px;
    --popup-shadow-vertical-offset: {{ settings.popup_shadow_vertical_offset | default: 4 }}px;
    --popup-shadow-blur-radius: {{ settings.popup_shadow_blur | default: 5 }}px;
    
    /* Drawer variables */
    --drawer-border-width: {{ settings.drawer_border_thickness | default: 1 }}px;
    --drawer-border-opacity: {{ settings.drawer_border_opacity | default: 10 | divided_by: 100.0 }};
    --drawer-shadow-opacity: {{ settings.drawer_shadow_opacity | default: 0 | divided_by: 100.0 }};
    --drawer-shadow-horizontal-offset: {{ settings.drawer_shadow_horizontal_offset | default: 0 }}px;
    --drawer-shadow-vertical-offset: {{ settings.drawer_shadow_vertical_offset | default: 4 }}px;
    --drawer-shadow-blur-radius: {{ settings.drawer_shadow_blur | default: 5 }}px;
    
    /* Text boxes variables */
    --text-boxes-border-opacity: {{ settings.text_boxes_border_opacity | default: 10 | divided_by: 100.0 }};
    --text-boxes-border-width: {{ settings.text_boxes_border_thickness | default: 0 }}px;
    --text-boxes-radius: {{ settings.text_boxes_radius | default: 0 }}px;
    --text-boxes-shadow-opacity: {{ settings.text_boxes_shadow_opacity | default: 0 | divided_by: 100.0 }};
    --text-boxes-shadow-horizontal-offset: {{ settings.text_boxes_shadow_horizontal_offset | default: 0 }}px;
    --text-boxes-shadow-vertical-offset: {{ settings.text_boxes_shadow_vertical_offset | default: 4 }}px;
    --text-boxes-shadow-blur-radius: {{ settings.text_boxes_shadow_blur | default: 5 }}px;
    
    /* Variant pills variables */
    --variant-pills-radius: {{ settings.variant_pills_radius | default: 40 }}px;
    --variant-pills-border-width: {{ settings.variant_pills_border_thickness | default: 1 }}px;
    --variant-pills-border-opacity: {{ settings.variant_pills_border_opacity | default: 55 | divided_by: 100.0 }};
    --variant-pills-shadow-opacity: {{ settings.variant_pills_shadow_opacity | default: 0 | divided_by: 100.0 }};
    --variant-pills-shadow-horizontal-offset: {{ settings.variant_pills_shadow_horizontal_offset | default: 0 }}px;
    --variant-pills-shadow-vertical-offset: {{ settings.variant_pills_shadow_vertical_offset | default: 4 }}px;
    --variant-pills-shadow-blur-radius: {{ settings.variant_pills_shadow_blur | default: 5 }}px;
  }
  
  {%- comment -%} Responsive Design System - Standardized Breakpoints {%- endcomment -%}
  
  /* Mobile First - Extra Small (up to 480px) */
  @media (max-width: calc(var(--breakpoint-xs) - 1px)) {
    :root {
      --font-heading-scale: {{ settings.heading_font_scale | default: 120 | divided_by: 100.0 | times: 0.8 }};
      --container-width: 100%;
      --grid-columns: 1;
      --spacing-md: 0.5rem;
      --spacing-lg: 0.75rem;
      --spacing-xl: 1rem;
    }
  }
  
  /* Small devices (480px to 767px) */
  @media (min-width: var(--breakpoint-xs)) and (max-width: calc(var(--breakpoint-md) - 1px)) {
    :root {
      --font-heading-scale: {{ settings.heading_font_scale | default: 120 | divided_by: 100.0 | times: 0.9 }};
      --container-width: 100%;
      --grid-columns: 2;
      --spacing-md: 0.75rem;
      --spacing-lg: 1rem;
      --spacing-xl: 1.5rem;
    }
  }
  
  {%- comment -%} Dark mode support (if enabled) {%- endcomment -%}
  @media (prefers-color-scheme: dark) {
    :root {
      --color-background: #1a1a1a;
      --color-text: #ffffff;
      --shadow: 0 1px 3px 0 rgba(255, 255, 255, 0.1);
    }
  }
  
  {%- comment -%} High contrast mode {%- endcomment -%}
  @media (prefers-contrast: high) {
    :root {
      --color-primary: #000000;
      --color-background: #ffffff;
      --color-text: #000000;
    }
  }
  
  {%- comment -%} Reduced motion support {%- endcomment -%}
  @media (prefers-reduced-motion: reduce) {
    :root {
      --transition-fast: 0ms;
      --transition-base: 0ms;
      --transition-slow: 0ms;
    }
    
    * {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }
  
  {%- comment -%} Standardized Responsive Breakpoints {%- endcomment -%}
  
  /* Extra Small - xs: 480px+ */
  @media (min-width: var(--breakpoint-xs)) {
    :root {
      --container-padding: 1.5rem;
      --grid-gutter: 1rem;
    }
  }
  
  /* Small - sm: 640px+ */
  @media (min-width: var(--breakpoint-sm)) {
    :root {
      --container-padding: 2rem;
      --grid-gutter: 1.5rem;
    }
  }
  
  /* Medium - md: 768px+ (Tablets) */
  @media (min-width: var(--breakpoint-md)) {
    :root {
      --container-padding: 2.5rem;
      --grid-gutter: 2rem;
      --font-heading-scale: {{ settings.heading_font_scale | default: 120 | divided_by: 100.0 }};
      --grid-columns: {{ settings.collection_layout | default: 3 }};
    }
  }
  
  /* Large - lg: 1024px+ (Laptops) */
  @media (min-width: var(--breakpoint-lg)) {
    :root {
      --container-padding: 3rem;
      --grid-gutter: 2.5rem;
      --font-heading-scale: {{ settings.heading_font_scale | default: 120 | divided_by: 100.0 }};
      --grid-columns: {{ settings.collection_layout | default: 4 }};
    }
  }
  
  /* Extra Large - xl: 1200px+ (Desktops) */
  @media (min-width: var(--breakpoint-xl)) {
    :root {
      --container-padding: 4rem;
      --grid-gutter: 3rem;
      --grid-columns: {{ settings.collection_layout | default: 5 }};
    }
  }
  
  /* 2X Extra Large - 2xl: 1400px+ (Large Desktops) */
  @media (min-width: var(--breakpoint-2xl)) {
    :root {
      --container-padding: 5rem;
      --grid-gutter: 3.5rem;
      --grid-columns: {{ settings.collection_layout | default: 6 }};
    }
  }
</style>

{%- comment -%} Performance optimization - Inline critical CSS {%- endcomment -%}
<style>
  /* Critical CSS - Above the fold */
  body {
    font-family: var(--font-body);
    font-size: var(--font-size-base);
    line-height: 1.6;
    color: var(--color-text);
    background-color: var(--color-background);
    margin: 0;
    padding: 0;
  }
  
  .container {
    max-width: var(--container-width);
    margin: 0 auto;
    padding: 0 var(--spacing-md);
  }
  
  /* Loading states */
  .loading {
    opacity: 0.6;
    pointer-events: none;
  }
  
  /* Accessibility */
  .visually-hidden {
    position: absolute !important;
    overflow: hidden;
    width: 1px;
    height: 1px;
    margin: -1px;
    padding: 0;
    border: 0;
    clip: rect(0 0 0 0);
  }
  
  .skip-link {
    position: absolute;
    top: -40px;
    left: 6px;
    z-index: var(--z-index-modal);
    padding: 8px;
    background: var(--color-primary);
    color: var(--color-background);
    text-decoration: none;
    transition: top var(--transition-fast);
  }
  
  .skip-link:focus {
    top: 6px;
  }
</style>