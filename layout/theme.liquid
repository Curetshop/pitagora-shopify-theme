<!doctype html>
{%- comment -%}
  TEMA PITAGORA v1.0
  Arquitectura híbrida enterprise basada en análisis de 4 temas premium
  - Base: Vettro (Reformation) - Analytics enterprise
  - Custom Elements: Focal v4 - Sistema de eventos
  - UI Components: Shrine Pro - Componentes avanzados  
  - SEO: California - Optimización avanzada
{%- endcomment -%}

{%- capture dir -%}
  {%- case request.locale.iso_code -%}
    {%- when 'ae' or 'ar' or 'arc' or 'bcc' or 'bqi' or 'ckb' or 'dv' or 'fa' or 'glk' or 'ha' or 'he' or 'kwh' or 'ks' or 'ku' or 'mzn' or 'nqo' or 'pnb' or 'ps' or 'sd' or 'ug' or 'ur' or 'yi' -%}
      rtl
    {%- else -%}
      ltr
  {%- endcase -%}
{%- endcapture -%}

<html class="no-js" lang="{{ request.locale.iso_code }}" dir="{{ dir }}">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, viewport-fit=cover">
  <meta name="theme-color" content="{{ settings.color_primary | default: '#000000' }}">
  
  <link rel="canonical" href="{{ canonical_url }}">
  <link rel="preconnect" href="https://cdn.shopify.com" crossorigin>
  
  {%- comment -%} Preload critical resources {%- endcomment -%}
  {%- render 'head-preload' -%}

  {%- comment -%} Favicon {%- endcomment -%}
  {%- if settings.favicon != blank -%}
    <link rel="icon" type="image/png" href="{{ settings.favicon | image_url: width: 32, height: 32 }}">
  {%- endif -%}

  {%- comment -%} SEO optimizado - Base California {%- endcomment -%}
  <title>
    {{ page_title }}{% if current_tags %}{% assign meta_tags = current_tags | join: ', ' %} &ndash; {{ 'general.meta.tags' | t: tags: meta_tags }}{% endif %}{% if current_page != 1 %} &ndash; {{ 'general.meta.page' | t: page: current_page }}{% endif %}{% unless page_title contains shop.name %} &ndash; {{ shop.name }}{% endunless %}
  </title>

  {%- if page_description -%}
    <meta name="description" content="{{ page_description | escape }}">
  {%- endif -%}

  {%- comment -%} Font preloading - Focal v4 pattern {%- endcomment -%}
  {%- unless settings.heading_font.system? and settings.body_font.system? -%}
    <link rel="preconnect" href="https://fonts.shopifycdn.com" crossorigin>
  {%- endunless -%}

  {%- comment -%} Social meta tags {%- endcomment -%}
  {%- render 'social-meta-tags' -%}

  {%- comment -%} Critical CSS inline for fastest loading {%- endcomment -%}
  {{ 'critical.css' | asset_url | stylesheet_tag }}

  {%- comment -%} Preload non-critical CSS and load asynchronously {%- endcomment -%}
  <link rel="preload" href="{{ 'app.css' | asset_url }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="{{ 'app.css' | asset_url }}"></noscript>

  {%- comment -%} Preload individual component stylesheets {%- endcomment -%}
  <link rel="preload" href="{{ 'header.css' | asset_url }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="preload" href="{{ 'product-card.css' | asset_url }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="preload" href="{{ 'collection.css' | asset_url }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <link rel="preload" href="{{ 'product.css' | asset_url }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
  
  {%- comment -%} Template-specific CSS loading {%- endcomment -%}
  {%- case template.name -%}
    {%- when 'product' -%}
      <link rel="preload" href="{{ 'product-siblings.css' | asset_url }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
      <link rel="preload" href="{{ 'ai-recommendations.css' | asset_url }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
    {%- when 'collection' -%}
      <link rel="preload" href="{{ 'collection.css' | asset_url }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
    {%- when 'cart' -%}
      <link rel="preload" href="{{ 'cart.css' | asset_url }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
      <link rel="preload" href="{{ 'cart-drawer.css' | asset_url }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
    {%- when 'blog' -%}
      <link rel="preload" href="{{ 'blog.css' | asset_url }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
      <link rel="preload" href="{{ 'blog-posts.css' | asset_url }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
    {%- when 'article' -%}
      <link rel="preload" href="{{ 'article.css' | asset_url }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
    {%- when '404' -%}
      <link rel="preload" href="{{ '404.css' | asset_url }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
  {%- endcase -%}
  
  {%- comment -%} Section-specific CSS loading {%- endcomment -%}
  {%- for section in sections -%}
    {%- case section.type -%}
      {%- when 'testimonials' -%}
        <link rel="preload" href="{{ 'testimonials.css' | asset_url }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
      {%- when 'featured-collections' -%}
        <link rel="preload" href="{{ 'featured-collections.css' | asset_url }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
      {%- when 'featured-products' -%}
        <link rel="preload" href="{{ 'featured-products.css' | asset_url }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
      {%- when 'newsletter' -%}
        <link rel="preload" href="{{ 'newsletter.css' | asset_url }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
      {%- when 'instagram-feed' -%}
        <link rel="preload" href="{{ 'instagram-feed.css' | asset_url }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
      {%- when 'voice-search' -%}
        <link rel="preload" href="{{ 'voice-search.css' | asset_url }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
    {%- endcase -%}
  {%- endfor -%}

  {%- comment -%} CSS Variables - Focal v4 system {%- endcomment -%}
  {%- render 'css-variables' -%}

  {%- comment -%} Analytics Enterprise - Vettro base {%- endcomment -%}
  {%- if settings.google_analytics_4 != blank -%}
    <script async src="https://www.googletagmanager.com/gtag/js?id={{ settings.google_analytics_4 }}"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', '{{ settings.google_analytics_4 }}');
    </script>
  {%- endif -%}

  {%- if settings.facebook_pixel != blank -%}
    <script>
      !function(f,b,e,v,n,t,s)
      {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
      n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s)}(window, document,'script',
      'https://connect.facebook.net/en_US/fbevents.js');
      fbq('init', '{{ settings.facebook_pixel }}');
      fbq('track', 'PageView');
    </script>
  {%- endif -%}

  {%- if settings.hotjar_site_id != blank -%}
    <script>
      (function(h,o,t,j,a,r){
        h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
        h._hjSettings={hjid:{{ settings.hotjar_site_id }},hjsv:6};
        a=o.getElementsByTagName('head')[0];
        r=o.createElement('script');r.async=1;
        r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
        a.appendChild(r);
      })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
    </script>
  {%- endif -%}

  {%- comment -%} Theme JavaScript variables {%- endcomment -%}
  <script>
    window.theme = window.theme || {};
    theme = {
      info: {
        name: 'Pitagora',
        version: '1.0.0',
        author: 'Enterprise Hybrid'
      },
      settings: {
        money_format: {{ shop.money_format | json }},
        money_with_currency_format: {{ shop.money_with_currency_format | json }},
        cart_drawer: {{ settings.cart_drawer | default: false }},
        product_id: {% if product %}{{ product.id }}{% else %}false{% endif %},
        predictive_search: {{ settings.predictive_search | default: true }},
        quick_view: {{ settings.enable_quick_view | default: true }}
      },
      routes: {
        root_url: '{{ routes.root_url }}',
        cart_url: '{{ routes.cart_url }}',
        cart_add_url: '{{ routes.cart_add_url }}',
        cart_change_url: '{{ routes.cart_change_url }}',
        cart_update_url: '{{ routes.cart_update_url }}',
        search_url: '{{ routes.search_url }}',
        predictive_search_url: '{{ routes.predictive_search_url }}'
      },
      strings: {
        addToCart: {{ 'products.product.add_to_cart' | t | json }},
        soldOut: {{ 'products.product.sold_out' | t | json }},
        unavailable: {{ 'products.product.unavailable' | t | json }},
        preOrder: {{ 'products.product.pre_order' | t | json }},
        quickView: {{ 'products.product.quick_view' | t | json }},
        loading: {{ 'general.accessibility.loading' | t | json }},
        close: {{ 'general.accessibility.close' | t | json }}
      }
    };
  </script>

  {{ content_for_header }}
</head>

<body class="template-{{ template.name | handle }}{% if customer %} customer-logged-in{% endif %}{% if settings.animations_enabled %} animations-enabled{% endif %}">
  
  {%- comment -%} Skip link for accessibility {%- endcomment -%}
  <a class="skip-link visually-hidden" href="#MainContent">
    {{ 'general.accessibility.skip_to_content' | t }}
  </a>

  {%- comment -%} Loading overlay {%- endcomment -%}
  <div class="loading-overlay" aria-hidden="true">
    <div class="loading-spinner"></div>
  </div>

  {%- comment -%} Header group - Focal v4 pattern {%- endcomment -%}
  {%- sections 'header-group' -%}

  {%- comment -%} Main content area {%- endcomment -%}
  <main id="MainContent" class="main-content" role="main" tabindex="-1">
    {{ content_for_layout }}
  </main>

  {%- comment -%} Footer group {%- endcomment -%}
  {%- sections 'footer-group' -%}

  {%- comment -%} Drawer/Modal containers - Custom elements ready {%- endcomment -%}
  <div id="drawer-container"></div>
  <div id="modal-container"></div>

  {%- comment -%} Security utilities - Load first {%- endcomment -%}
  {{ 'security-utils.js' | asset_url | script_tag }}
  {{ 'error-handler.js' | asset_url | script_tag }}
  {{ 'css-loader.js' | asset_url | script_tag }}
  {{ 'custom-elements.js' | asset_url | script_tag }}
  
  {%- comment -%} Main JavaScript - Deferred for performance {%- endcomment -%}
  {{ 'app.js' | asset_url | script_tag: defer: 'defer' }}

  {%- comment -%} Remove no-js class {%- endcomment -%}
  <script>
    document.documentElement.classList.remove('no-js');
    document.documentElement.classList.add('js');
    
    // Loading state management
    window.addEventListener('load', function() {
      document.body.classList.add('loaded');
      setTimeout(function() {
        const loadingOverlay = document.querySelector('.loading-overlay');
        if (loadingOverlay) {
          loadingOverlay.style.display = 'none';
        }
      }, 100);
    });
  </script>

  {%- comment -%} WhatsApp Floating Button - Global {%- endcomment -%}
  {%- sections 'whatsapp-group' -%}

  {%- comment -%} Theme editor support {%- endcomment -%}
  {%- if request.design_mode -%}
    {{ 'theme-editor.js' | asset_url | script_tag: defer: 'defer' }}
  {%- endif -%}

</body>
</html>